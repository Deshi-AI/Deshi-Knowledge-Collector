# Deshi Knowledge Collector - Slack Bot

This project provides a Slack bot designed to collect messages from a designated Slack user and store them in a Supabase database. This data can then be used for various purposes, such as training AI models (like Sensay Replicas) or creating an eternal enterprise memory.

It includes two ways to run the bot:
1.  **Streamlit Web UI (`app.py`):** Offers a user-friendly interface for configuration and basic monitoring.
2.  **Console Application (`console_bot.py`):** A command-line version for headless operation.

## Features

*   Listens for messages from a specific Slack user.
*   Stores captured messages (content, user ID, channel ID, timestamp) in Supabase.
*   Filters out bot messages and non-text messages.
*   Handles potential duplicate messages based on Slack's message timestamp.
*   Provides basic logging of its activities.

## Prerequisites

*   Python 3.8+
*   A Slack Workspace where you have permissions to create and install apps.
*   A Supabase account and project.

## Setup Guide

Follow these steps to set up the necessary services and obtain your environment variables.

### 1. Slack App Setup

You need to create a Slack App to get the API tokens required for the bot.

1.  **Create a New Slack App:**
    *   Go to [https://api.slack.com/apps](https://api.slack.com/apps).
    *   Click "Create New App".
    *   Choose "From scratch".
    *   **App Name:** Give your app a name (e.g., "Deshi Collector").
    *   **Workspace:** Select the Slack workspace you want the bot to operate in.
    *   Click "Create App".

2.  **Enable Socket Mode:**
    *   This mode allows your bot to connect to Slack without needing a publicly accessible HTTP endpoint, which is great for local development or running behind a firewall.
    *   In your app's settings page, go to **Settings > Socket Mode** from the sidebar.
    *   Toggle "Enable Socket Mode" ON.
    *   Acknowledge any prompts.
    *   **Generate an App-Level Token:** Click "Generate token to enable Socket Mode".
        *   Give the token a name (e.g., `deshi-socket-token`).
        *   Click "Generate".
        *   **Important:** Copy this token immediately. It starts with `xapp-`. This will be your `SLACK_APP_TOKEN`.

3.  **Configure Bot Token Scopes (Permissions):**
    *   From the sidebar, go to **Features > OAuth & Permissions**.
    *   Scroll down to the "Scopes" section.
    *   Under "Bot Token Scopes", click "Add an OAuth Scope" and add the following:
        *   `channels:history` (to read messages in public channels the bot is in)
        *   `groups:history` (to read messages in private channels the bot is in)
        *   `im:history` (to read messages in DMs the bot is part of)
        *   `users:read` (to potentially map user IDs to names - helpful for debugging)
        *   *(Optional)* `chat:write` (if you ever want the bot to send messages, like confirmations or reactions)

4.  **Install App to Workspace:**
    *   Still on the **OAuth & Permissions** page, scroll to the top and click "Install to Workspace".
    *   Review the permissions and click "Allow".
    *   **Important:** After installation, you will be shown a **Bot User OAuth Token**. Copy this token immediately. It starts with `xoxb-`. This will be your `SLACK_BOT_TOKEN`.

5.  **Subscribe to Bot Events:**
    *   From the sidebar, go to **Features > Event Subscriptions**.
    *   Toggle "Enable Events" ON.
    *   Under "Subscribe to bot events", click "Add Bot User Event" and add:
        *   `message.channels` (for messages in public channels)
        *   `message.groups` (for messages in private channels)
        *   `message.im` (for DMs and group DMs the bot is part of)
    *   Scroll down and click "Save Changes".

### 2. Supabase Setup

You'll use Supabase to store the collected Slack messages.

1.  **Create a Supabase Project:**
    *   Go to [https://supabase.com/](https://supabase.com/) and sign up or log in.
    *   Create a new project. Choose a name and region.
    *   Wait for your project to be provisioned.

2.  **Create a Table for Messages:**
    *   Once your project is ready, navigate to the **SQL Editor** (icon looks like a terminal or `</>`).
    *   Click "+ New query".
    *   Paste and run the following SQL to create the table:
        ```sql
        CREATE TABLE slack_messages_for_sensay (
            id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
            slack_user_id TEXT NOT NULL,
            slack_channel_id TEXT,
            message_content TEXT NOT NULL,
            slack_message_ts TEXT UNIQUE, -- Slack's message timestamp, for deduplication
            processed_for_sensay BOOLEAN DEFAULT FALSE, -- For future use if integrating with Sensay API
            created_at TIMESTAMPTZ DEFAULT NOW()
        );
        ```
        *You can change `slack_messages_for_sensay` to a different table name if you prefer, but make sure to update the `SUPABASE_TABLE_NAME` environment variable accordingly.*

3.  **Get Supabase API Credentials:**
    *   In your Supabase project, go to **Project Settings** (the gear icon in the left sidebar).
    *   Select **API**.
    *   You will need two pieces of information:
        *   **Project URL:** Find this under "Configuration > URL". Copy it. This will be your `SUPABASE_URL`.
        *   **Service Role Key:** Under "Project API keys", find the `service_role` key. Click "Reveal" and copy it. **Treat this key like a password; it has admin privileges to your database.** This will be your `SUPABASE_SERVICE_KEY`.

### 3. Identify Target Slack User ID

You need the unique Slack User ID of the person whose messages you want to collect.

1.  Open your Slack client.
2.  Find the user in your workspace.
3.  Click on their profile picture or name to open their profile.
4.  Click the three dots ("More") icon.
5.  Select "Copy member ID". This ID typically starts with `U` (e.g., `U08S39L92AG`). This will be your `TARGET_SLACK_USER_ID`.

## Environment Variables

The bot requires the following environment variables to function:

*   `SLACK_BOT_TOKEN`: Your Bot User OAuth Token (starts with `xoxb-`).
*   `SLACK_APP_TOKEN`: Your App-Level Token for Socket Mode (starts with `xapp-`).
*   `SUPABASE_URL`: Your Supabase project URL.
*   `SUPABASE_SERVICE_KEY`: Your Supabase `service_role` secret key.
*   `TARGET_SLACK_USER_ID`: The Slack User ID of the person whose messages you want to collect.
*   `SUPABASE_TABLE_NAME`: The name of the table in Supabase where messages will be stored (defaults to `slack_messages_for_sensay` if not set or if using the console bot's default).

You can set these in two ways:

1.  **`.env` file (Recommended for local development):**
    Create a file named `.env` in the root directory of the project and add your variables:
    ```env
    SLACK_BOT_TOKEN="xoxb-YOUR_SLACK_BOT_TOKEN"
    SLACK_APP_TOKEN="xapp-YOUR_SLACK_APP_TOKEN"
    SUPABASE_URL="YOUR_SUPABASE_URL"
    SUPABASE_SERVICE_KEY="YOUR_SUPABASE_SERVICE_KEY"
    TARGET_SLACK_USER_ID="YOUR_TARGET_SLACK_USER_ID"
    SUPABASE_TABLE_NAME="slack_messages_for_sensay"
    ```
2.  **Directly in the Streamlit UI or Console Prompts:**
    *   The Streamlit app (`app.py`) will ask you to input these values in its web interface if they are not found in `.env`.
    *   The console app (`console_bot.py`) will prompt you in the terminal if they are not found in `.env`.

## Running the Bot

### Dependencies

First, install the required Python packages:

```bash
pip install -r requirements.txt
